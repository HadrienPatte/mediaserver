server {
  listen 80;
  listen [::]:80;

  server_name {{ ansible_host }};

  location /nginx-status {
    # only allow local connections from the datadog-agent
    allow 127.0.0.1;
    deny all;

    stub_status;

    # ensures the version information can be retrieved
    server_tokens on;
  }

  location / {
    root /var/www/html/homer;
  }

  location /css {
    root /var/www/html/theme.park/theme.park-1.13.6;
  }

{% for name in containers %}
{% set container = containers[name] %}
{% if container.proxy %}

  location /{{ name }} {
    proxy_pass http://localhost:{{ container.port }}/{{ name }};
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-for $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $remote_addr;
    proxy_set_header X-Forwarded-Protocol $scheme;
    proxy_redirect off;

    # Send websocket data to the backend aswell
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_set_header Accept-Encoding "";
    sub_filter
    '</head>'
    '<link rel="stylesheet" type="text/css" href="/css/base/{{ name }}/{{ name }}-base.css">
    <link rel="stylesheet" type="text/css" href="/css/theme-options/nord.css">
    </head>';
    sub_filter_once on;
  }
{% endif %}
{% endfor %}
}
